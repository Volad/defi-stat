<div class="container">
    <h1>{{ title }}</h1>

    <!-- Inputs -->
    <div class="row">
        <div class="card">
            <h3>Inputs</h3>

            <!-- Row 1: network + collateral + borrow -->
            <div class="row gap12">
                <div>
                    <label>Network</label>
                    <mat-form-field appearance="outline" style="min-width:220px;">
                        <mat-select [(value)]="network" (selectionChange)="onNetworkChange()">
                            <mat-option *ngFor="let n of networks" [value]="n">{{ n }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="grow">
                    <label>Collateral</label>
                    <mat-form-field class="grow" appearance="outline">
                        <input
                                type="text"
                                matInput
                                placeholder="Type address/symbol/name"
                                [formControl]="collateralCtrl"
                                [matAutocomplete]="autoCol"
                        />
                        <mat-autocomplete
                            #autoCol="matAutocomplete"
                            (optionSelected)="onSelectCollateral($event.option.value)"
                            [displayWith]="displayAsset"
                        >
                            <mat-option *ngFor="let a of collateralOptions" [value]="a.vaultAddress">
                                {{ a.vaultSymbol }} — {{ a.vaultAddress }}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                    <div class="muted">Selected: {{ collateral }}</div>
                </div>

                <div class="grow">
                    <label>Borrow</label>
                    <mat-form-field class="grow" appearance="outline">
                        <input
                                type="text"
                                matInput
                                placeholder="Type address/symbol/name"
                                [formControl]="borrowCtrl"
                                [matAutocomplete]="autoBor"
                        />
                        <mat-autocomplete
                            #autoBor="matAutocomplete"
                            (optionSelected)="onSelectBorrow($event.option.value)"
                            [displayWith]="displayAsset"
                        >
                            <mat-option *ngFor="let a of borrowOptions" [value]="a.vaultAddress">
                                {{ a.vaultSymbol }} — {{ a.vaultAddress }}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                    <div class="muted">Selected: {{ borrow }}</div>
                </div>
            </div>

            <!-- Row 2: params + date-range + build -->
            <!-- second line: numbers + (date-range + build) -->
            <div class="row align-end gap12" style="margin-top:12px; margin-bottom: 10px">
                <div>
                    <label>Leverage</label>
                    <input type="number" [(ngModel)]="leverage" step="0.1" min="1" />
                </div>
                <div>
                    <label>Rewards Collateral (%)</label>
                    <input type="number" [(ngModel)]="rewardCollateral" step="0.01" />
                </div>
                <div>
                    <label>Rewards Borrow (%)</label>
                    <input type="number" [(ngModel)]="rewardBorrow" step="0.01" />
                </div>

                <!-- NEW: this block takes the remaining space -->
                <div class="range-build-row grow">
                    <!-- 70%: date range -->
                    <div class="range-area">
                        <label>Date range</label>
                        <mat-form-field class="date-range" appearance="outline">
                            <mat-date-range-input [rangePicker]="picker" [formGroup]="dateRange" [separator]="' – '">
                                <input matStartDate formControlName="start" placeholder="Start date" readonly />
                                <input matEndDate   formControlName="end"   placeholder="End date" readonly />
                            </mat-date-range-input>
                            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-date-range-picker #picker></mat-date-range-picker>
                        </mat-form-field>

<!--                        <div class="muted">-->
<!--                            from {{ (dateRange.value.start || dateFrom) | date:'yyyy-MM-dd HH:mm:ss' }}-->
<!--                            to   {{ (dateRange.value.end || dateTo)   | date:'yyyy-MM-dd HH:mm:ss' }}-->
<!--                        </div>-->
                    </div>

                    <!-- 30%: build button -->
                    <div class="build-area">
                        <button class="w-100" mat-raised-button color="primary" (click)="applyPickedRange(); buildSeries()">
                            Build Chart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary (Averages) -->
    <div class="row" style="margin-top:16px;">
        <div class="card">
            <h3>Summary (Averages)</h3>

            <div class="avg-grid">
                <!-- 7d -->
                <div class="avg-item">
                    <b>7d supply %</b><br />
                    {{ stats.avg7d.supply | number:'1.2-2' }}%
                </div>
                <div class="avg-item">
                    <b>7d debt %</b><br />
                    {{ stats.avg7d.borrow | number:'1.2-2' }}%
                </div>
                <div class="avg-item">
                    <b>7d ROE %</b><br />
                    {{ stats.avg7d.roe | number:'1.2-2' }}%
                </div>

                <!-- 30d -->
                <div class="avg-item">
                    <b>30d supply %</b><br />
                    {{ stats.avg30d.supply | number:'1.2-2' }}%
                </div>
                <div class="avg-item">
                    <b>30d debt %</b><br />
                    {{ stats.avg30d.borrow | number:'1.2-2' }}%
                </div>
                <div class="avg-item">
                    <b>30d ROE %</b><br />
                    {{ stats.avg30d.roe | number:'1.2-2' }}%
                </div>

                <!-- Visible range averages -->
                <div class="avg-item">
                    <b>Supply %</b><br />
                    {{ stats.avgVisible.supply | number:'1.2-2' }}%
                </div>
                <div class="avg-item">
                    <b>Debt %</b><br />
                    {{ stats.avgVisible.borrow | number:'1.2-2' }}%
                </div>
                <div class="avg-item">
                    <b>ROE %</b><br />
                    {{ stats.avgVisible.roe | number:'1.2-2' }}%
                </div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="row" style="margin-top:16px;">
        <div class="card chart-pad" style="height:400px;">
            <h3>APY & ROE</h3>
            <canvas
                    baseChart
                    [type]="'line'"
                    [data]="lineChartData"
                    [options]="lineChartOptions">
            </canvas>
        </div>
    </div>

    <!-- Range slider -->
    <div class="row" style="margin-top:8px;">
        <div class="card" style="padding:12px 16px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="muted" style="width:80px;">Range</span>
                <mat-slider min="0" max="1000" step="1" class="grow">
                    <input matSliderStartThumb [(ngModel)]="brushStart" (input)="onBrushChange()" />
                    <input matSliderEndThumb   [(ngModel)]="brushEnd"   (input)="onBrushChange()" />
                </mat-slider>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="row" style="margin-top:16px;">
        <div class="table-wrap">
            <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2 full-width centered-table">
                <!-- Timestamp -->
                <ng-container matColumnDef="timestamp">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header><b>Timestamp</b></th>
                    <td mat-cell *matCellDef="let row">{{ row.timestamp | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                </ng-container>

                <!-- Supply % -->
                <ng-container matColumnDef="supply">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header><b>Supply %</b></th>
                    <td mat-cell *matCellDef="let row">{{ row.supply | number:'1.2-2' }}%</td>
                </ng-container>

                <!-- Supply reward % -->
                <ng-container matColumnDef="supplyReward">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header><b>Supply reward %</b></th>
                    <td mat-cell *matCellDef="let row">{{ row.supplyReward | number:'1.2-2' }}%</td>
                </ng-container>

                <!-- Borrow % -->
                <ng-container matColumnDef="borrow">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header><b>Borrow %</b></th>
                    <td mat-cell *matCellDef="let row">{{ row.borrow | number:'1.2-2' }}%</td>
                </ng-container>

                <!-- Borrow reward % -->
                <ng-container matColumnDef="borrowReward">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header><b>Borrow reward %</b></th>
                    <td mat-cell *matCellDef="let row">{{ row.borrowReward | number:'1.2-2' }}%</td>
                </ng-container>

                <!-- ROE % -->
                <ng-container matColumnDef="roe">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header><b>ROE %</b></th>
                    <td mat-cell *matCellDef="let row">{{ row.roe | number:'1.2-2' }}%</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
        </div>
    </div>
</div>