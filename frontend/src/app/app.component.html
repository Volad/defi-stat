<div class="container">
    <h1>{{ title }}</h1>

    <div class="row">
        <div class="card grow">
            <h3>Inputs</h3>

            <!-- Material autocompletes -->
            <div class="row">
                <div class="grow">
                    <label>Collateral</label>
                    <mat-form-field class="grow" appearance="outline">

                        <input type="text" matInput placeholder="Type address/symbol/name" [formControl]="collateralCtrl" [matAutocomplete]="autoCol"
                        >
                        <mat-autocomplete #autoCol="matAutocomplete" (optionSelected)="onSelectCollateral($event.option.value)" [displayWith]="displayAsset">
                            <mat-option *ngFor="let a of collateralOptions" [value]="a.vaultAddress">
                                {{a.vaultSymbol}} — {{a.vaultAddress}}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                    <div class="muted">Selected: {{ collateral }}</div>
                </div>

                <div class="grow">
                    <label>Borrow</label>
                    <mat-form-field class="grow" appearance="outline">

                        <input type="text" matInput placeholder="Type address/symbol/name" [formControl]="borrowCtrl" [matAutocomplete]="autoBor">
                        <mat-autocomplete #autoBor="matAutocomplete" (optionSelected)="onSelectBorrow($event.option.value)" [displayWith]="displayAsset">
                            <mat-option *ngFor="let a of borrowOptions" [value]="a.vaultAddress">
                                {{a.vaultSymbol}} — {{a.vaultAddress}}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                    <div class="muted">Selected: {{ borrow }}</div>
                </div>
            </div>

            <div class="row" style="margin-top:12px;">
                <div>
                    <label>Leverage</label>
                    <input type="number" [(ngModel)]="leverage" step="0.1" min="1" />
                </div>
                <div>
                    <label>Rewards Collateral (%)</label>
                    <input type="number" [(ngModel)]="rewardCollateral" step="0.01" />
                </div>
                <div>
                    <label>Rewards Borrow (%)</label>
                    <input type="number" [(ngModel)]="rewardBorrow" step="0.01" />
                </div>
                <div class="grow">
                    <label>Range</label>
                    <div class="btn-group">
                        <button mat-flat-button color="basic" (click)="computeRange('1d')">Last 1 day</button>
                        <button mat-flat-button color="basic" (click)="computeRange('30d')">Last 30 days</button>
                        <button mat-flat-button color="basic" (click)="computeRange('360d')">Last 360 days</button>
                    </div>
                    <div class="muted">from {{fromISO}} to {{toISO}}</div>
                </div>
                <div style="display:flex; align-items:end;">
                    <button mat-raised-button color="primary" (click)="buildSeries()">Build Chart</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="margin-top:16px;">
        <div class="card grow" style="height:400px;">
            <h3>APY & ROE</h3>
            <canvas baseChart
                    [type]="'line'"
                    [data]="lineChartData"
                    [options]="lineChartOptions">
            </canvas>
        </div>
    </div>
    <div class="row" style="margin-top:16px;">
        <div class="chart-controls" style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:8px;">
            <mat-checkbox [checked]="!lineChartData.datasets[2]?.hidden" (change)="toggleDatasetVisibility(2)">
                ROE
            </mat-checkbox>
            <mat-checkbox [checked]="!lineChartData.datasets[0]?.hidden" (change)="toggleDatasetVisibility(0)">
                Supply %
            </mat-checkbox>
            <mat-checkbox [checked]="!lineChartData.datasets[1]?.hidden" (change)="toggleDatasetVisibility(1)">
                Borrow %
            </mat-checkbox>
            <mat-checkbox [checked]="!lineChartData.datasets[3]?.hidden" (change)="toggleDatasetVisibility(3)">
                Supply reward %
            </mat-checkbox>
            <mat-checkbox [checked]="!lineChartData.datasets[4]?.hidden" (change)="toggleDatasetVisibility(4)">
                Borrow reward %
            </mat-checkbox>
        </div>
    </div>

    <div class="row" style="margin-top:16px;">
        <!-- Scrollable wrapper; sticky header works when parent can scroll -->
        <div class="table-wrap">
            <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2 full-width centered-table">

                <!-- Timestamp -->
                <ng-container matColumnDef="timestamp">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Timestamp </th>
                    <td mat-cell *matCellDef="let row">
                        {{ row.timestamp | date:'yyyy-MM-dd HH:mm:ss' }}
                    </td>
                </ng-container>

                <!-- Supply % -->
                <ng-container matColumnDef="supply">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Supply % </th>
                    <td mat-cell *matCellDef="let row">
                        {{ row.supply | number:'1.2-2' }}%
                    </td>
                </ng-container>

                <!-- Supply reward % -->
                <ng-container matColumnDef="supplyReward">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Supply reward % </th>
                    <td mat-cell *matCellDef="let row">
                        {{ row.supplyReward | number:'1.2-2' }}%
                    </td>
                </ng-container>

                <!-- Borrow % -->
                <ng-container matColumnDef="borrow">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Borrow % </th>
                    <td mat-cell *matCellDef="let row">
                        {{ row.borrow | number:'1.2-2' }}%
                    </td>
                </ng-container>

                <!-- Borrow reward % -->
                <ng-container matColumnDef="borrowReward">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Borrow reward % </th>
                    <td mat-cell *matCellDef="let row">
                        {{ row.borrowReward | number:'1.2-2' }}%
                    </td>
                </ng-container>

                <!-- ROE % -->
                <ng-container matColumnDef="roe">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> ROE % </th>
                    <td mat-cell *matCellDef="let row">
                        {{ row.roe | number:'1.2-2' }}%
                    </td>
                </ng-container>

                <!-- Sticky header row; body rows are scrollable in wrapper -->
                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            </table>
        </div>
    </div>
</div>